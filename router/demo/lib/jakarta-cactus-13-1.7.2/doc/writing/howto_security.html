<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0.1//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="author" content="">
<link media="screen" type="text/css" rel="stylesheet" href=".././css/apache.css">
<link media="print" type="text/css" rel="stylesheet" href=".././css/print.css">
<title>Testing secure code Howto</title>
</head>
<body>
<table width="100%" cellspacing="0" id="header">
<tr>
<td id="projectLogo" class="logo"><a href="http://jakarta.apache.org/"><img alt="The Apache Jakarta Project" src=".././images/jakarta-logo.gif"></a></td><td id="subprojectLogo" class="logo"><a href="http://jakarta.apache.org/cactus/"><img alt="Testing secure code Howto" src=".././images/logocactus.gif"></a></td>
</tr>
<tr id="contextBar">
<td id="breadCrumbs"><a href="http://www.apache.org/">Apache</a> &gt; <a href="http://jakarta.apache.org/">Jakarta</a> &gt; <a href=".././index.html">Cactus</a> &gt; <a href=".././writing/howto_testcase.html">Writing Tests</a></td><td id="status">
              Docs for:
              <strong>v1.7.2</strong> | <a href=".././..">v1.7</a>
              &nbsp;&nbsp;
              Last update: March 26 2006</td>
</tr>
</table>
<table id="main">
<tr>
<td id="sidebar">
<div id="navigation">
<ul>

  
<li>
<a href=".././index.html" title="Describes what the Cactus framework is, defines several types of unit tests and explains which are best implemented with Cactus.">Main Page</a>
<ul></ul>
</li>

  
<li>Writing Tests<ul>
    
<li>
<a href=".././writing/howto_testcase.html" title="Introduction to writing Cactus-based unit tests.">General Principles</a>
</li>
    
<li>
<a href=".././writing/howto_testcase_servlet.html" title="Information on writing Cactus-based tests to test Servlets.">Testing Servlets</a>
</li>
    
<li>
<a href=".././writing/howto_testcase_filter.html" title="How to write unit tests for Servlet Filters using Cactus.">Testing Filters</a>
</li>
    
<li>
<a href=".././writing/howto_jsp.html" title="How to write unit tests for JSP pages using Cactus.">Testing JSP Pages</a>
</li>
    
<li>
<a href=".././writing/howto_testcase_jsp.html" title="How to write unit tests for JSP tag libraries using Cactus.">Testing Taglibs</a>
</li>
    
<li>
<a href=".././writing/howto_ejb.html" title="How to test Enterprise JavaBeans using Cactus.">Testing EJBs</a>
</li>
  
</ul>
</li>

  
<li>Advanced Topics<ul>
    
<li>
<a href=".././writing/howto_httpunit.html" title="How to use HttpUnit tests inside Cactus test cases">Integrating HttpUnit</a>
</li>
    
<li>
<a href=".././writing/howto_security.html" title="" class="currentPage">Using Authentication</a>
</li>
  
</ul>
</li>

  
<li>Reference<ul>
    
<li>
<a href=".././api/framework-12/index.html" title="">Javadocs (J2EE 1.2)</a>
</li>
    
<li>
<a href=".././api/framework-13/index.html" title="">Javadocs (J2EE 1.3)</a>
</li>
  
</ul>
</li>


<li>
<img src="images/cactusbanner.gif"></li>
</ul>
</div>
</td><td id="content">

  

  

    
<div class="section">
<h1>Introduction to testing secure code</h1>

      
<p>
        Beginning with version 1.3, Cactus is able to unit test Servlet code
        that uses the Servlet Security API (<code>getRemoteUser()</code>,
        <code>isUserInRole()</code>, <code>getUserPrincipal()</code>).
        Cactus supports the BASIC and FORM authentication methods.
      </p>
      
<p>
        The way to perform this is by securing a Servlet Redirector defined
        in your <code>web.xml</code> and then to specify user credentials
        in your <code>beginXXX()</code>, as defined below.
      </p>

      
<div class="note">
        The Cactus sample application demonstrates how to unit test everything
        that is explained here.
      </div>

    
</div>

    
<div class="section">
<h1>Step 1: Passing credentials in beginXXX()</h1>

      
<p>
        Let's start with an example:
      </p>


<div class="source">
<pre>
public void beginBasicAuthentication(WebRequest theRequest)
{
    theRequest.setRedirectorName("ServletRedirectorSecure");
    theRequest.setAuthentication(
        new BasicAuthentication("testuser", "testpassword"));
}

public void testBasicAuthentication()
{
    assertEquals("testuser", request.getUserPrincipal().getName());
    assertEquals("testuser", request.getRemoteUser());
    assertTrue("User not in 'test' role", request.isUserInRole("test"));
}
</pre>
</div>

      
<p>
        There are several things to understand here:
      </p>
      
<ul>
        
<li>
          The Servlet that is called on the server side is the Cactus
          redirector servlet and thus we'll need to secure it in
          our <code>web.xml</code> (see step 2 below).
        </li>
        
<li>
          
<code>WebRequest.setRedirectorName()</code> is an API that lets you
          override the redirector defined in <code>cactus.properties</code>.
          This is needed here because we want to test both code that is not
          secured (i.e. for which we don't want to have to pass credentials)
          and code that is secured and thus we need 2 redirectors. The
          <code>ServletRedirectorSecure</code> redirector will be secured
          in step 2 below.
        </li>
        
<li>
          
<code>WebRequest.setAuthentication()</code> is used to pass
          credentials to the server. It takes an implementation of the 
          <code>Authentication</code> interface as argument. In this example,
          we pass in a <code>BasicAuthentication</code> which corresponds to
          the BASIC authentication method. Testing with form-based
          authentication just involves using the
          <code>FormAuthentication</code> class instead of
          <code>BasicAuthentication</code>.
        </li>
      
</ul>

    
</div>

    
<div class="section">
<h1>Step 2: Securing the Cactus Redirector</h1>

      
<div class="note">
        If you're using the Cactus Ant tasks to execute your Cactus
        tests, please check the <a href=".././integration/ant/task_cactifywar.html" title="Documentation for the <cactifywar> task provided by Cactus.">Cactifywar
        task</a> page as the configuration below is only required 
        for manual configuration and is handled automatically by the
        Cactifywar task.
      </div> 
      
<p>
        All calls to the server side go through the Cactus Servlet Redirector
        and thus it is that servlet that needs to be secured in
        <code>web.xml</code>. The required modifications to <code>web.xml</code>
        are as follows (example):
       </p>


<div class="source">
<pre>
[...]

&lt;web-app&gt;

  &lt;servlet&gt;
    &lt;servlet-name&gt;ServletRedirector&lt;/servlet-name&gt;
    &lt;servlet-class&gt;org.apache.cactus.server.ServletTestRedirector&lt;/servlet-class&gt;
  &lt;/servlet&gt;

  &lt;servlet&gt;
    &lt;servlet-name&gt;ServletRedirectorSecure&lt;/servlet-name&gt;
    &lt;servlet-class&gt;org.apache.cactus.server.ServletTestRedirector&lt;/servlet-class&gt;
  &lt;/servlet&gt;

  [...]

  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;ServletRedirector&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/ServletRedirector&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;

  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;ServletRedirectorSecure&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/ServletRedirectorSecure&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;

  [...]

  &lt;!-- Start Authentication --&gt;

  &lt;security-constraint&gt;
    &lt;web-resource-collection&gt;
      &lt;web-resource-name&gt;SecurityRestriction&lt;/web-resource-name&gt;
      &lt;description&gt;Protect the Cactus redirector servlet.&lt;/description&gt;
      &lt;url-pattern&gt;/ServletRedirectorSecure&lt;/url-pattern&gt;
      &lt;http-method&gt;GET&lt;/http-method&gt;
      &lt;http-method&gt;POST&lt;/http-method&gt;
    &lt;/web-resource-collection&gt;
    &lt;auth-constraint&gt;
      &lt;description&gt;Authorized Users Group&lt;/description&gt;
      &lt;role-name&gt;test&lt;/role-name&gt;
    &lt;/auth-constraint&gt;
    &lt;user-data-constraint&gt;
      &lt;transport-guarantee&gt;NONE&lt;/transport-guarantee&gt;
    &lt;/user-data-constraint&gt;
  &lt;/security-constraint&gt;

  &lt;login-config&gt;
    &lt;auth-method&gt;BASIC&lt;/auth-method&gt;
  &lt;/login-config&gt;

  &lt;security-role&gt;
    &lt;description&gt;Test role&lt;/description&gt;
    &lt;role-name&gt;test&lt;/role-name&gt;
  &lt;/security-role&gt;

  &lt;!-- End Authentication --&gt;

&lt;/web-app&gt;
</pre>
</div>

    
</div>

    
<div class="section">
<h1>Step 3: Map Users/Roles</h1>

      
<p>
        This step consists in defining authorized users and mapping them to the
        role defined in <code>web.xml</code> (e.g. in the example above, we have
        defined a <code>test</code> role).
      </p>

      
<p>
        This step is completely container-dependent and there is no standard
        way of doing it. You'll have to learn how to do it for your container.
        For example, here is how you would do it for Tomcat 4.0:
      </p>
      
<ul>
        
<li>
          Create a <code>tomcat-users.xml</code> file that you put in your
          Tomcat configuration directory (where you have
          <code>server.xml</code> defined).
        </li>
      
</ul>
      
<p>
        Here is an example of <code>tomcat-users.xml</code> that matches the
        test we have defined in step 1:
      </p>


<div class="source">
<pre>
&lt;tomcat-users&gt;
  &lt;user name="testuser" password="testpassword" roles="test" /&gt;
&lt;/tomcat-users&gt;
</pre>
</div>

    
</div>

  

</td>
</tr>
</table>
<div id="footer">
<p>
	    Copyright &copy; 2000-2004 The Apache Software Foundation.
            All Rights Reserved.
	  </p>
</div>
</body>
</html>
